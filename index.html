<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Four Rail Journeys</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Custom colors for status/accents in dark mode
                        'rail-blue': '#4d94ff',
                        'southern-green': '#00b359',
                        'overground-orange': '#ffaa00',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        /* Dark mode card styling */
        .card-bg {
            background: #1f2937; /* Dark Gray 800 for card background */
            box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.1), 0 4px 6px -2px rgba(255, 255, 255, 0.05);
        }
        .refresh-icon {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Ensure responsive font sizes for mobile */
        h2 { font-size: 1.5rem; } /* sm:text-2xl */
        @media (min-width: 640px) {
            h2 { font-size: 1.75rem; }
        }
    </style>
</head>
<body class="bg-black text-white p-4 sm:p-8 font-sans min-h-screen">
    <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- Header (Only includes a friendly message for context) -->
        <header class="text-center pb-4 border-b border-gray-800">
            <h1 class="text-4xl font-extrabold text-white">Live Rail Journey Segments</h1>
        </header>

        <!-- Journey List -->
        <div id="journey-list" class="space-y-6">
            <!-- Journeys will be rendered here -->
            <div class="text-center p-8 text-gray-400">Loading live data...</div>
        </div>
        
        <!-- Status moved to the bottom -->
        <div id="status-message" class="text-center pt-4 text-gray-400">
            <!-- Data last updated... will go here -->
        </div>

    </div>

    <script type="text/javascript">
        
        // --- Utility to calculate duration between two HH:mm strings ---
        const calculateDuration = (startTimeStr, endTimeStr) => {
            const [startH, startM] = startTimeStr.split(':').map(Number);
            const [endH, endM] = endTimeStr.split(':').map(Number);
            
            let startDate = new Date();
            startDate.setHours(startH, startM, 0, 0);

            let endDate = new Date();
            endDate.setHours(endH, endM, 0, 0);

            // Handle case where end time wraps to the next day (e.g., 23:50 -> 00:10)
            if (endDate < startDate) {
                endDate.setDate(endDate.getDate() + 1);
            }

            const diffMs = endDate - startDate;
            const diffMins = Math.round(diffMs / 60000); // convert milliseconds to minutes
            return diffMins;
        };

        // --- Helper Function to render ONE complete journey option (Leg 1 + Transfer + Leg 2) ---
        const renderOneChangeOption = (journey, conn) => {
            const firstLeg = journey.first_leg;
            const secondLeg = conn.second_leg;
            const transferTime = conn.transferTime;
            const totalDurationToDisplay = journey.totalDuration; // Placeholder until data script update
            
            // First Leg Operator Color
            const operatorId = firstLeg.operator;
            let operatorColor = 'text-gray-400';
            if (operatorId && operatorId.toLowerCase().includes('southern')) {
                operatorColor = 'text-southern-green';
            } else if (operatorId && operatorId.toLowerCase().includes('overground')) {
                operatorColor = 'text-overground-orange';
            }

            // Get Platforms
            const streathamPlatformKey = Object.keys(firstLeg).find(key => key.startsWith('departurePlatform_Streatham'));
            const streathamPlatform = firstLeg[streathamPlatformKey] || 'TBC';
            const claphamPlatformKey = Object.keys(secondLeg).find(key => key.startsWith('departurePlatform_Clapham'));
            const claphamPlatform = secondLeg[claphamPlatformKey] || 'TBC';
            
            // Calculate leg durations
            const firstLegDuration = calculateDuration(firstLeg.departure, firstLeg.arrival);
            const secondLegDuration = calculateDuration(secondLeg.departure, secondLeg.arrival);
            
            return `
                <div class="card-bg p-4 sm:p-6 rounded-xl border border-gray-800 space-y-3">
                    
                    <!-- Main Header Row: Departure Time and Total Duration -->
                    <div class="flex justify-between items-center pb-2 border-b border-gray-700">
                        <h3 class="text-3xl font-extrabold text-white">
                            ${firstLeg.departure}
                        </h3>
                        <p class="text-lg font-semibold text-green-400">Total: ${totalDurationToDisplay}</p>
                    </div>

                    <!-- Journey Steps (Mimicking the 3-row flat structure from the image) -->
                    <div class="space-y-3">
                        
                        <!-- 1. First Leg (SC -> CJ) -->
                        <div class="flex justify-between text-sm items-center">
                            <div class="w-1/3 font-medium text-white">
                                <span class="block">${firstLeg.departure} - ${firstLeg.arrival}</span>
                                <span class="text-xs text-gray-500 block">${firstLegDuration} mins</span>
                            </div>
                            <div class="w-1/3 text-center text-gray-400 text-xs font-medium">
                                Streatham Common $\rightarrow$ Clapham Jcn
                            </div>
                            <div class="w-1/3 text-right">
                                <span class="font-semibold text-white block">P: ${streathamPlatform}</span>
                                <span class="text-xs ${operatorColor}">${firstLeg.operator}</span>
                            </div>
                        </div>

                        <!-- 2. Transfer Row (Bigger and bolder, with yellow accent) -->
                        <div class="flex justify-between text-sm items-center py-1 border-y border-gray-800 bg-gray-900 rounded-md px-2">
                            <span class="text-xl font-black text-yellow-400">${transferTime} transfer</span>
                            <span class="text-xs text-gray-400">at Clapham Junction</span>
                        </div>

                        <!-- 3. Second Leg (CJ -> IW) -->
                        <div class="flex justify-between text-sm items-center">
                            <div class="w-1/3 font-medium text-white">
                                <span class="block">${secondLeg.departure} - ${secondLeg.arrival}</span>
                                <span class="text-xs text-gray-500 block">${secondLegDuration} mins</span>
                            </div>
                            <div class="w-1/3 text-center text-gray-400 text-xs font-medium">
                                Clapham Jcn $\rightarrow$ Imperial Wharf
                            </div>
                            <div class="w-1/3 text-right">
                                <span class="font-semibold text-white block">P: ${claphamPlatform}</span>
                                <span class="text-xs ${operatorColor}">${secondLeg.operator}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer Status -->
                    <div class="pt-2 border-t border-gray-700 text-right">
                        <span class="text-sm font-semibold p-1 px-2 rounded ${journey.status === 'On Time' ? 'bg-green-600' : 'bg-red-600'} text-white">
                            ${journey.status}
                        </span>
                    </div>
                </div>
            `;
        };

        
        // --- Main Card Renderer ---
        const renderJourneyCard = (journey) => {
            if (journey.type === 'Direct') {
                // If it's a direct journey, render a simple single card.
                const firstLeg = journey.first_leg;
                const operatorId = firstLeg.operator;
                let operatorColor = 'text-gray-400';
                if (operatorId && operatorId.toLowerCase().includes('southern')) {
                    operatorColor = 'text-southern-green';
                } else if (operatorId && operatorId.toLowerCase().includes('overground')) {
                    operatorColor = 'text-overground-orange';
                }
                const streathamPlatformKey = Object.keys(firstLeg).find(key => key.startsWith('departurePlatform_Streatham'));
                const streathamPlatform = firstLeg[streathamPlatformKey] || 'TBC';
                const duration = calculateDuration(firstLeg.departure, firstLeg.arrival);

                return `
                    <div class="card-bg p-4 sm:p-6 rounded-xl border border-gray-800 space-y-3">
                        
                        <!-- Main Header Row -->
                        <div class="flex justify-between items-center pb-2 border-b border-gray-700">
                            <h3 class="text-3xl font-extrabold text-white">
                                ${firstLeg.departure}
                            </h3>
                            <p class="text-lg font-semibold text-green-400">Total: ${journey.totalDuration}</p>
                        </div>

                        <!-- Journey Details -->
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm items-center py-2 bg-gray-900 rounded-md px-2">
                                <div class="w-1/3 font-medium text-white">
                                    <span class="block">${firstLeg.departure} - ${firstLeg.arrival}</span>
                                    <span class="text-xs text-gray-500 block">${duration} mins</span>
                                </div>
                                <div class="w-1/3 text-center text-green-500 font-bold">
                                    DIRECT TRAIN
                                </div>
                                <div class="w-1/3 text-right">
                                    <span class="font-semibold text-white block">P: ${streathamPlatform}</span>
                                    <span class="text-xs ${operatorColor}">${firstLeg.operator}</span>
                                </div>
                            </div>
                            <div class="text-center text-xs text-gray-500">
                                Streatham Common $\rightarrow$ Imperial Wharf (No changes)
                            </div>
                        </div>
                        
                        <!-- Footer Status -->
                        <div class="pt-2 border-t border-gray-700 text-right">
                            <span class="text-sm font-semibold p-1 px-2 rounded ${journey.status === 'On Time' ? 'bg-green-600' : 'bg-red-600'} text-white">
                                ${journey.status}
                            </span>
                        </div>
                    </div>
                `;
            }

            // If it's a One Change Journey, generate a card for *each* connection option
            let connectionsHtml = '';
            if (journey.connections) {
                journey.connections.forEach(conn => {
                    connectionsHtml += renderOneChangeOption(journey, conn);
                });
            }
            return connectionsHtml;
        };


        // --- Data Fetching and Initialization ---
        const fetchAndRenderJourneys = async () => {
            const journeyListElement = document.getElementById('journey-list');
            const statusElement = document.getElementById('status-message');
            
            // Show loading state
            journeyListElement.innerHTML = `<div class="text-center p-8 text-white"><span class="refresh-icon">↻</span> Loading live data...</div>`;
            statusElement.innerHTML = `<p class="text-sm text-gray-500">Checking for updates...</p>`;

            try {
                // Fetch the static JSON file
                // Adding a cache-buster query parameter
                const response = await fetch('live_data.json?t=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide loading and render results
                // The map/join handles the new structure where renderJourneyCard may return multiple HTML blocks
                const renderedHtml = data.map(renderJourneyCard).join('');
                journeyListElement.innerHTML = renderedHtml || `
                    <div class="text-center p-8 text-gray-400">No journeys found in live_data.json.</div>
                `;

                if (data.length > 0) {
                    // Assuming the timestamp is the same for all entries in the run
                    const lastUpdated = data[0].live_updated_at;
                    statusElement.innerHTML = `Data last updated by Harvester at: <span class="font-bold text-white">${lastUpdated}</span>`;
                } else {
                    statusElement.innerHTML = `No recent data available. Waiting for next run.`;
                }
                
            } catch (error) {
                console.error("Could not fetch data from static JSON:", error);
                // Updated error message to use dark mode colors
                journeyListElement.innerHTML = `
                    <div class="card-bg p-8 rounded-xl text-center border border-red-700">
                        <p class="text-xl font-semibold text-red-400">Failed to load live_data.json.</p>
                        <p class="text-gray-400">Check if the data script is running successfully.</p>
                    </div>
                `;
                statusElement.innerHTML = `Failed to connect to data source.`;
            }
        }
        
        // Initial load and set up client-side refresh (to check for new static file)
        document.addEventListener('DOMContentLoaded', fetchAndRenderJourneys);
        // Periodically check for a new static file every 10 seconds
        setInterval(fetchAndRenderJourneys, 10000); 
    </script>
</body>
</html>
