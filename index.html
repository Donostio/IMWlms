<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next Four Rail Journeys</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // Custom colors for status/accents in dark mode
                        'rail-blue': '#4d94ff',
                        'southern-green': '#00b359',
                        'overground-orange': '#ffaa00',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        /* Dark mode card styling */
        .card-bg {
            background: #1f2937; /* Dark Gray 800 for card background */
            box-shadow: 0 10px 15px -3px rgba(255, 255, 255, 0.1), 0 4px 6px -2px rgba(255, 255, 255, 0.05);
        }
        .refresh-icon {
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Ensure responsive font sizes for mobile */
        h2 { font-size: 1.5rem; } /* sm:text-2xl */
        @media (min-width: 640px) {
            h2 { font-size: 1.75rem; }
        }
    </style>
</head>
<body class="bg-black text-white p-4 sm:p-8 font-sans min-h-screen">
    <div class="max-w-4xl mx-auto space-y-8">
        
        <!-- Header (Only includes a friendly message for context) -->
        <header class="text-center pb-4 border-b border-gray-800">
            <h1 class="text-4xl font-extrabold text-white">Live Rail Journey Segments</h1>
        </header>

        <!-- Journey List -->
        <div id="journey-list" class="space-y-6">
            <!-- Journeys will be rendered here -->
            <div class="text-center p-8 text-gray-400">Loading live data...</div>
        </div>
        
        <!-- Status moved to the bottom -->
        <div id="status-message" class="text-center pt-4 text-gray-400">
            <!-- Data last updated... will go here -->
        </div>

    </div>

    <script type="text/javascript">
        
        // --- Helper Function for Connections ---
        const renderConnection = (conn, isFirst, totalDuration) => {
            const secondLeg = conn.second_leg;
            const transferTime = conn.transferTime; // e.g., "13 min"
            
            // Dynamically find the platform key for the second leg (Clapham Junction)
            const claphamPlatformKey = Object.keys(secondLeg).find(key => key.startsWith('departurePlatform_Clapham'));
            const platformDisplay = secondLeg[claphamPlatformKey] || 'TBC';
            
            // Total Duration is now shown on ALL connections with the new requested phrasing
            const durationDisplay = `<p class="font-bold text-sm text-green-400">Total journey: ${totalDuration}</p>`;
            
            return `
                <div class="p-4 rounded-lg border border-gray-700 bg-gray-900 shadow-md">
                    
                    <!-- Transfer Time (Bigger, Bolder, Rewritten) -->
                    <div class="text-center mb-3">
                        <p class="text-3xl font-black text-yellow-400">${transferTime} transfer</p>
                    </div>
                    
                    <!-- Second Leg Details (The Connection) -->
                    <div class="flex justify-between items-center text-lg font-medium">
                        <p>${secondLeg.departure} <span class="text-gray-400">from Clapham Jcn</span></p>
                        <p>${secondLeg.arrival} <span class="text-gray-400">to IW</span></p>
                    </div>
                    
                    <!-- Platform & Total Duration Footer -->
                    <div class="flex justify-between items-center text-xs text-gray-400 pt-2 mt-2 border-t border-gray-700">
                        <p>Platform: <span class="font-semibold text-white">${platformDisplay}</span></p>
                        <!-- Total Duration now displayed here on every connection -->
                        ${durationDisplay}
                    </div>
                </div>
            `;
        };
        
        // --- Main Card Renderer ---
        const renderJourneyCard = (journey) => {
            const firstLeg = journey.first_leg;
            
            // Determine colors based on operator (for visual flair)
            const operatorId = firstLeg.operator;
            let operatorColor = 'text-gray-400';
            if (operatorId && operatorId.toLowerCase().includes('southern')) {
                operatorColor = 'text-southern-green';
            } else if (operatorId && operatorId.toLowerCase().includes('overground')) {
                operatorColor = 'text-overground-orange';
            }
            
            // First Leg Header: Remove "Segment X: " and use " - "
            const timeRangeDisplay = `${firstLeg.departure} - ${firstLeg.arrival}`;
            
            // Dynamically find the platform key for the first leg (Streatham Common)
            const streathamPlatformKey = Object.keys(firstLeg).find(key => key.startsWith('departurePlatform_Streatham'));
            const streathamPlatform = firstLeg[streathamPlatformKey] || 'TBC';
            
            // Connections Header: Use new wording
            const connectionCount = journey.connections ? journey.connections.length : 0;
            const connectionHeader = connectionCount === 1 
                ? `1 possible train to catch to Imperial Wharf`
                : `${connectionCount} possible trains to catch to Imperial Wharf`;

            // Render connections 
            const connectionsHtml = journey.connections ? journey.connections.map((conn, index) => 
                // Pass totalDuration to renderConnection for display in every box
                renderConnection(conn, index === 0, journey.totalDuration)
            ).join('') : '';

            return `
                <div class="card-bg p-6 rounded-xl border border-gray-800">
                    
                    <!-- Main Time Range and Status -->
                    <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-700">
                        <h2 class="font-extrabold text-white">
                            ${timeRangeDisplay}
                        </h2>
                        <span class="text-sm font-semibold p-1 rounded ${journey.status === 'On Time' ? 'bg-green-600' : 'bg-red-600'} text-white">
                            ${journey.status}
                        </span>
                    </div>

                    <!-- First Leg Details (The train from Streatham Common) -->
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between">
                            <p class="text-gray-300">Scheduled:</p>
                            <p class="font-semibold text-white">${firstLeg.scheduled_departure}</p>
                        </div>
                        <div class="flex justify-between">
                            <p class="text-gray-300">Platform:</p>
                            <p class="font-semibold text-white">${streathamPlatform}</p>
                        </div>
                        <div class="flex justify-between">
                            <p class="text-gray-300">Operator:</p>
                            <p class="font-semibold ${operatorColor}">${operatorId}</p>
                        </div>
                    </div>
                    
                    <!-- Connections Section (Only for One Change journeys) -->
                    ${journey.type === 'One Change' ? `
                        <div class="mt-6 pt-4 border-t border-gray-700">
                            <!-- New connections header -->
                            <p class="text-base font-semibold mb-3 text-yellow-400">${connectionHeader}</p>
                            
                            <div class="space-y-4">
                                ${connectionsHtml}
                            </div>
                        </div>
                    ` : `
                        <div class="mt-6 pt-4 border-t border-gray-700">
                            <p class="text-base font-semibold text-green-500">DIRECT Train - No Change Required</p>
                            <p class="text-sm text-gray-400 pt-1">Total Duration: <span class="font-bold text-white">${journey.totalDuration}</span></p>
                        </div>
                    `}
                </div>
            `;
        };


        // --- Data Fetching and Initialization ---
        const fetchAndRenderJourneys = async () => {
            const journeyListElement = document.getElementById('journey-list');
            const statusElement = document.getElementById('status-message');
            
            // Show loading state
            journeyListElement.innerHTML = `<div class="text-center p-8 text-white"><span class="refresh-icon">â†»</span> Loading live data...</div>`;
            statusElement.innerHTML = `<p class="text-sm text-gray-500">Checking for updates...</p>`;

            try {
                // Fetch the static JSON file
                const response = await fetch('live_data.json?t=' + new Date().getTime());
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Hide loading and render results
                const renderedHtml = data.map(renderJourneyCard).join('');
                journeyListElement.innerHTML = renderedHtml;

                if (data.length > 0) {
                    const lastUpdated = data[0].live_updated_at;
                    // Updated to use white/gray text colors
                    statusElement.innerHTML = `Data last updated by Harvester at: <span class="font-bold text-white">${lastUpdated}</span>`;
                } else {
                    statusElement.innerHTML = `No recent data available. Waiting for next run.`;
                }
                
            } catch (error) {
                console.error("Could not fetch data from static JSON:", error);
                // Updated error message to use dark mode colors
                journeyListElement.innerHTML = `
                    <div class="card-bg p-8 rounded-xl text-center border border-red-700">
                        <p class="text-xl font-semibold text-red-400">Failed to load live_data.json.</p>
                        <p class="text-gray-400">Check if the data script is running successfully.</p>
                    </div>
                `;
                statusElement.innerHTML = `Failed to connect to data source.`;
            }
        }
        
        // Initial load and set up client-side refresh (to check for new static file)
        document.addEventListener('DOMContentLoaded', fetchAndRenderJourneys);
        // Periodically check for a new static file every 10 seconds
        setInterval(fetchAndRenderJourneys, 10000); 
    </script>
</body>
</html>
